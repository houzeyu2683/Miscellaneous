# 範例（基礎）

編輯者：侯則瑜
編輯時間：2022/02/03

這篇文件的目的是紀錄學習 Nginx 後的實際應用情境，透過完成實際的需求，來檢視自己是否真的理解並解決工作上的問題，會盡量用同一個情境下來延伸問題，訓練自己針對延伸的需求來進行回答。

###### 問題一

假設工作上有一台伺服器（18.123.21.17），其中有一個服務正在上面執行（假設是一個 flask 服務），並且佔用了 8081 端口。今天有一個需求是要你一個簡單的方法來實現反向代理的功能，其中對外開放的位置是 http://test1.service.com/t1 ，並已經配置好網域指向 ip 的部分。

新增一個文件 **test1.conf** ，這個檔案必須放在伺服器中的 **/etc/nginx/conf.d/** 資料夾內，以下代碼部分用來實現反向代理功能。

```
http {
    server {
        listen 80;
        server_name test1.service.com;
        location ~ /t1 {
            proxy_pass http://127.0.0.1:8081;
        }
    }
}
```

理論上這樣當用戶訪問 http://test1.service.com/t1 就會訪問開台伺服器上的 8081 端口服務。

###### 問題二

延續上面的問題，主管說當用戶數量變多的時候，會發現服務變慢或是延遲，反正就是體驗不佳，請你解決一下，這時候你知道 Nginx 有一個負載均衡的功能可以實現，所以需求是請你用 Nginx 負載均衡的功能來解決這個問題。首先你的工作夥伴已經幫你在端口 8082 多開了一個服務，對外位址一樣是 http://test1.service.com/t1 ，請你實現負載均衡的功能。

根據上述的配置文件來進行修改，關鍵是從 proxy_pass 這個參數來延伸，原先後續接的是實際的端口位置，接下來要做的事情是把它變成變量（ server_1 ），透過這個變量（ server_1 ）將 http://test1.service.com/t1 隨機分配給兩個不同端口但是相同功能的服務，來實現負載均衡，以下代碼部分用來實現反向代理功能。

```
upstream server_1 {
    server http://127.0.0.1:8081;
    server http://127.0.0.1:8082;
}

http {
    server {
        listen 80;
        server_name test1.service.com;
        location ~ /t1 {
            # proxy_pass http://127.0.0.1:8081;
            proxy_pass http://server_1;
        }
    }
}
```

###### 支線任務

接下來行銷端會開始推廣活動、提高用戶數量等等，這時候從問題一你會發現兩個服務（8081與8082）以及 Nginx 服務都在同一台伺服器上。接著你開始會很害怕一件事情，如果伺服器掛了，那你全部都掛了。所以你會開始分散風險，你可能會將這三個服務分別放在不同的伺服器上，所以你可能會將配置變成下面清單的形式。

- 服務 Nginx （18.123.21.17）且使用 80 端口

- 服務一 （18.123.21.77）且使用 8081 端口

- 服務二 （18.123.21.79）且使用 8082 端口

其中服務一跟服務二是提供一樣的服務內容，但是原先是放在 Nginx 服務的伺服器上，現在改成獨立到各自的伺服器上。基於上述的描述，原先服務 Nginx 伺服器中的配置會修改成下面的代碼（不確定服務一、服務二的伺服器是否也必須裝 Nginx ，確認後補充）。

```
upstream server_1 {
    server http://18.123.21.77:8081;
    server http://18.123.21.79:8082;
}

http {
    server {
        listen 80;
        server_name test1.service.com;
        location ~ /t1 {
            ##  下面的 $1 爆幹重要。
            ##  如果不加，上面 location 的 /t1 會跟著跑去 server_1 的路徑後面。
            ##  最後會因為你的 8081 或 8082 端口下面沒有這個路徑，返回 404 。
            proxy_pass http://server_1/$1;
        }
    }
}
```

###### 問題三

有一天 Nginx 那台伺服器掛了，結果你被幹到飛天，所以接下來的需求是解決即使 Nginx 伺服器掛了，但是服務不能掛的這個問題。

阿這...我還不知道怎用...目前知道需要裝 keep a live 的東西



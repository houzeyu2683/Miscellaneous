# Nginx

編輯者：侯則瑜
編輯時間：2022/02/03

###### 問題一

假設工作上有一台伺服器（18.123.21.17），其中有一個服務正在上面執行（假設是一個 flask 服務），已知佔用 8081 端口且對外防火牆已經打開。今天有一個需求是要你用一個方法來實現反向代理的功能，對外開放的位置是 http://18.123.21.17/service/  。

在伺服器（18.123.21.17）的 **/etc/nginx/conf.d/** 資料夾內新增一個 **service.conf** 文件，文件的配置參考以下內容，理論上當用戶訪問 http://18.123.21.17/service/ 就會訪問伺服器上的 8081 端口服務。 

```
server {
    listen 80;
    server_name 18.123.21.17;
    location ~ /service/ {
        proxy_pass http://127.0.0.1:8081;
    }
}
```

###### 問題二

延續上面的問題，行銷端說當用戶數量變多的時候，發現服務會變慢導致體驗不佳，請你解決。 Nginx 有提供負載均衡的功能可以實現，對外位址一樣是 http://18.123.21.17/service/ 。假設你的工作夥伴已經幫你在同一台伺服器上複製一個相同的服務，使用的是 8082 端口，請你實現負載均衡的功能。

根據上述的配置文件來進行修改，原先 proxy_pass 這個參數後面接的是一個實際的位址端口位置，要做的事情是把實際的位址端口位置變成變量（ vserver ），透過變量將訪問隨機分配給兩個相同服務（端口不同）來實現負載均衡，配置修改如以下內容。

```
upstream vserver {
    server http://127.0.0.1:8081;
    server http://127.0.0.1:8082;
}

server {
    listen 80;
    server_name 18.123.21.17;
    location ~ /service/ {
        proxy_pass http://vserver;
    }
}
```

###### 問題三

接下來行銷端會開始推廣活動、提高用戶數量等等，這時候你會有些空檔。但你會發現目前兩個服務（8081與8082）以及 Nginx 服務都在同一台伺服器上，此時如果這台伺服器掛了，服務一與服務二就會掛，這樣風險挺大的。因此，為了分散風險，你可能會將這三個服務分別放在不同的伺服器上，假設你選擇使用下面清單的形式來部屬上面三個服務（再次提醒服務一跟服務二是兩個相同的應用內容），你的夥伴也幫你都把服務運行起來，剩下設定的部分請你來完成。

- 服務 Nginx （18.123.21.17）使用 80 端口

- 服務一 （18.123.21.77）使用 8081 端口

- 服務二 （18.123.21.79）使用 8082 端口

基於上述的描述，原先的服務 Nginx 伺服器中的配置將會進行修改，內容參考以下代碼，要特別注意 `$1` 這個符號，必須要加上，否則會訪問失敗。

```
upstream vserver {
    server http://18.123.21.77:8081;
    server http://18.123.21.79:8082;
}

server {
    listen 80;
    server_name 18.123.21.17;
    location ~ /service/ {
        proxy_pass http://vserver/$1;
    } 
}
```

###### 問題四

不管是服務一或是服務二都正常地在運行，他們原先都會使用各自的靜態資源，但這些靜態資源有時會統一管理，基於這樣的情境，假設公司新增一台伺服器（12.333.23.41）來存放靜態資源，請你在這台伺服器上配置 Nginx 文件，讓你的夥伴可以利用網路位址的訪問方式來獲取靜態資源。

假設你決定用 http://12.333.23.41/app/static/ 位置來公開伺服器上的靜態資源資料夾（/data/static/）。伺服器中的 Nginx 配置放在 /etc/nginx/conf.d/display.conf 文件，修改參考下面內容，這裡需要注意的是使用 alias 參數，而不是 root 參數。

```
server {
    server_name 12.333.23.414;
    listen 80;
    location ~ /app/static/ {
        alias /data/static/;
        autoindex on;
    }
}
```

